<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Apple Dark Mode Palette */
            --bg-primary: #000000;
            --bg-secondary: #1C1C1E; /* –ü–∞–Ω–µ–ª–∏ */
            --bg-tertiary: #2C2C2E; /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
            --bg-tertiary-hover: #3A3A3C;
            --bg-blur: rgba(28, 28, 30, 0.7); /* –î–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å—Ç–µ–∫–ª–∞ */
            
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF599; /* 60% opacity white */
            --text-tertiary: #EBEBF54D; /* 30% opacity white */
            
            --brand-blue: #0A84FF;
            --brand-blue-hover: #369DFF;
            --brand-green: #30D158;
            --brand-green-hover: #50E072;
            --brand-red: #FF453A;
            --brand-yellow: #FFD60A;
            
            --divider: rgba(84, 84, 88, 0.65);
        }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-secondary); 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ –≤ —Å—Ç–∏–ª–µ Apple */
        .apple-panel {
            background-color: var(--bg-blur);
            backdrop-filter: blur(12px) saturate(1.8);
            border: 1px solid rgba(84, 84, 88, 0.5); /* –ì—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Å—Ç–µ–∫–ª–∞ */
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* –ò–Ω–ø—É—Ç—ã */
        .apple-input {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--divider);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 15px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .apple-input:focus {
            outline: none;
            border-color: var(--brand-blue);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .apple-button {
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            padding: 10px 16px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .apple-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .apple-button-brand {
            background-color: var(--brand-blue);
            color: var(--text-primary);
        }
        .apple-button-brand:not(:disabled):hover {
            background-color: var(--brand-blue-hover);
        }
        
        .apple-button-spin {
            background-color: var(--brand-green);
            color: var(--text-primary);
            font-size: 18px;
            padding: 12px 24px;
            box-shadow: 0 0 15px rgba(48, 209, 88, 0.3);
        }
        .apple-button-spin:not(:disabled):hover {
            background-color: var(--brand-green-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(48, 209, 88, 0.4);
        }
        .apple-button-spin:not(:disabled):active {
            transform: translateY(0);
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ —Å—Ç–∏–ª–µ iOS */
        .apple-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }
        .apple-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .apple-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            transition: .4s;
            border-radius: 34px;
        }
        .apple-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .apple-slider {
            background-color: var(--brand-blue);
        }
        input:checked + .apple-slider:before {
            transform: translateX(20px);
        }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--bg-tertiary-hover); border-radius: 4px; }
        
        /* –°–ª–∞–π–¥–µ—Ä */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid var(--divider);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid var(--divider);
        }

        /* –ò–Ω–ø—É—Ç—ã (—É–±—Ä–∞—Ç—å —Å—Ç—Ä–µ–ª–∫–∏) */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { 
            -moz-appearance: textfield; 
        }
        
        /* –ü–æ–ø–∞–ø */
        .winner-popup { 
            background-color: rgba(0, 0, 0, 0.7); 
            backdrop-filter: blur(10px); 
        }
        .popup-panel {
            background-color: var(--bg-blur);
            border: 1px solid rgba(84, 84, 88, 0.5);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen w-full h-full p-4 box-border">
    <div class="w-full max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-start">
            
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
            <div classs="apple-panel p-4 rounded-lg shadow-lg order-2 lg:order-1 h-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
                    <button id="clear-participants" class="text-sm text-red-500 hover:text-red-400 font-medium">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
                </div>
                <div id="participants-cards-list" class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-center pt-8 text-sm text-gray-400">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                </div>
            </div>
            
            <!-- –¶–µ–Ω—Ç—Ä: –ö–æ–ª–µ—Å–æ -->
            <div class="flex flex-col items-center justify-center order-1 lg:order-2 lg:col-span-2">
                <h1 class="text-3xl font-bold text-white mb-2">–ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏</h1>
                <p id="wheel-subtitle" class="text-base text-gray-400 mb-4 hidden">–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
                
                <div id="canvas-container" class="relative w-full max-w-[500px] aspect-square mx-auto">
                    <!-- –ß–µ—Ä–µ–ø –≤ —Ü–µ–Ω—Ç—Ä–µ -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl z-20 opacity-90">üíÄ</div>
                    <!-- –°—Ç—Ä–µ–ª–∫–∞-—É–∫–∞–∑–∞—Ç–µ–ª—å -->
                    <div class="absolute -top-1 left-1/2 -translate-x-1/2 text-4xl" style="z-index: 10;">üîª</div>
                    <!-- –°–∞–º —Ö–æ–ª—Å—Ç –∫–æ–ª–µ—Å–∞ -->
                    <canvas id="wheel" class="w-full h-full wheel-shadow"></canvas>
                </div>
                
                <button id="spin-button" class="apple-button apple-button-spin mt-6 font-bold py-3 px-8 rounded-lg text-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    –ö—Ä—É—Ç–∏—Ç—å!
                </button>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="apple-panel p-4 rounded-lg shadow-lg order-3 lg:order-3 h-full">
                <h2 class="text-xl font-semibold text-white mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–≥—Ä—ã</h2>
                
                <!-- –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ -->
                <div class="mb-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-bold text-gray-300">–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞</label>
                        <div id="connection-status" class="text-sm font-bold text-yellow-400 flex items-center">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                        </div>
                    </div>
                </div>
                
                <hr class="border-divider mb-4">
                
                <div class="space-y-4">
                    <!-- –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                    <div id="add-mode-container" class="hidden">
                        <label class="text-sm font-bold text-gray-300">–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</label>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-sm text-gray-400">–í—Ä—É—á–Ω—É—é</span>
                            <label class="apple-switch">
                                <input type="checkbox" id="add-mode-toggle" disabled>
                                <span class="apple-slider"></span>
                            </label>
                            <span class="text-sm">–ò–∑ –∫–∞–Ω–∞–ª–∞</span>
                        </div>
                        <p id="mode-helper" class="text-xs text-gray-500 mt-2">–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Discord</p>
                    </div>

                    <!-- –†–µ–∂–∏–º –∏–≥—Ä—ã -->
                    <div>
                        <label class="text-sm font-bold text-gray-300">–†–µ–∂–∏–º –∏–≥—Ä—ã</label>
                        <div class="flex items-center justify-between mt-2">
                            <span class="text-sm text-gray-400">–ö–ª–∞—Å—Å–∏–∫–∞</span>
                            <label class="apple-switch">
                                <input type="checkbox" id="game-mode-toggle">
                                <span class="apple-slider"></span>
                            </label>
                            <span class="text-sm">–ù–∞ –≤—ã–±—ã–≤–∞–Ω–∏–µ</span>
                        </div>
                    </div>

                    <!-- –í—Ä–µ–º—è –≤—Ä–∞—â–µ–Ω–∏—è -->
                    <div>
                        <label for="spin-duration" class="block text-sm font-bold text-gray-300 mb-2">–í—Ä–µ–º—è –≤—Ä–∞—â–µ–Ω–∏—è (—Å–µ–∫)</label>
                        <input type="number" id="spin-duration" class="apple-input w-full" value="10" min="1" max="360">
                    </div>

                    <!-- –°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è -->
                    <div>
                        <label for="spin-speed" class="block text-sm font-bold text-gray-300 mb-2">–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è</label>
                        <input type="range" id="spin-speed" min="1" max="10" value="5" class="w-full">
                    </div>
                    
                    <hr class="border-divider">

                    <!-- –ü–∞–Ω–µ–ª—å —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div id="manual-controls" class="space-y-4">
                        <label class="text-sm font-bold text-gray-300">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                        <input type="text" id="name" class="apple-input w-full" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞">
                        <input type="number" id="bet" class="apple-input w-full" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏" min="1">
                        <button id="add-participant" class="apple-button apple-button-brand w-full font-bold">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div id="auto-controls" class="hidden space-y-4">
                        <label class="text-sm font-bold text-gray-300">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫–∞–Ω–∞–ª–∞</label>
                        <input type="number" id="auto-bet" class="apple-input w-full" value="100" min="1" placeholder="–°—Ç–∞–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö">
                        <button id="load-voice-participants" class="apple-button apple-button-brand w-full font-bold">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ–ø–∞–ø –ø–æ–±–µ–¥–∏—Ç–µ–ª—è -->
    <div id="result-popup" class="fixed inset-0 winner-popup flex items-center justify-center hidden z-50 p-4">
        <div class="popup-panel p-8 rounded-lg shadow-xl text-center transform transition-all scale-95 opacity-0 max-w-md w-full">
            <h2 id="popup-title" class="text-2xl font-bold text-gray-200 mb-2"></h2>
            <p class="text-5xl font-bold text-white mb-4" id="popup-name"></p>
            <p id="popup-subtitle" class="text-lg text-gray-400"></p>
            <button id="close-popup" class="mt-6 apple-button apple-button-brand font-bold py-2 px-6">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script type="module">
        // ----- SDK –∏ URL -----
        import { DiscordSDK } from 'https://cdn.jsdelivr.net/npm/@discord/embedded-app-sdk@latest/+esm';
        
        // !!! –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL –°–ï–†–í–ï–†–ê GLITCH –ò–õ–ò REPLIT !!!
        const backendUrl = 'WSS_URL_–í–ê–®–ï–ì–û_–°–ï–†–í–ï–†–ê_GLITCH'; 
        const clientId = '1292015094247264307'; // !!! –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® CLIENT ID !!!
        
        let ws;
        let discordSdk;

        // ----- UI –≠–ª–µ–º–µ–Ω—Ç—ã -----
        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvas-container');
        const spinBtn = document.getElementById('spin-button');
        const participantsCardsList = document.getElementById('participants-cards-list');
        const wheelSubtitle = document.getElementById('wheel-subtitle');
        
        // –ü–æ–ø–∞–ø
        const resultPopup = document.getElementById('result-popup');
        const popupTitle = document.getElementById('popup-title');
        const popupName = document.getElementById('popup-name');
        const popupSubtitle = document.getElementById('popup-subtitle');
        const closePopupBtn = document.getElementById('close-popup');
        
        // –°—Ç–∞—Ç—É—Å
        const connectionStatus = document.getElementById('connection-status');
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        const addModeContainer = document.getElementById('add-mode-container');
        const addModeToggle = document.getElementById('add-mode-toggle');
        const gameModeToggle = document.getElementById('game-mode-toggle');
        const spinDurationInput = document.getElementById('spin-duration');
        const spinSpeedInput = document.getElementById('spin-speed');
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        const manualControls = document.getElementById('manual-controls');
        const autoControls = document.getElementById('auto-controls');
        const nameInput = document.getElementById('name');
        const betInput = document.getElementById('bet');
        const addParticipantBtn = document.getElementById('add-participant');
        const autoBetInput = document.getElementById('auto-bet');
        const loadVoiceParticipantsBtn = document.getElementById('load-voice-participants');
        const clearParticipantsBtn = document.getElementById('clear-participants');

        // ----- –°–æ—Å—Ç–æ—è–Ω–∏–µ -----
        let participants = [];
        let isSpinning = false;
        let gameMode = 'classic'; // 'classic' or 'elimination'
        let voiceChannelMembers = [];
        
        // –¶–≤–µ—Ç–∞ (–ë–∞–∑–æ–≤—ã–µ + –ì—Ä–∞–¥–∏–µ–Ω—Ç)
        const baseColors = ['#0A84FF', '#FF453A', '#30D158', '#FF9F0A', '#FFD60A', '#AF52DE', '#64D2FF', '#FF4F0A'];
        
        // –ß–∏—Ç–∞–µ–º CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        const computedStyle = getComputedStyle(document.documentElement);
        let bgPrimaryColor = computedStyle.getPropertyValue('--bg-primary').trim() || '#000000';
        let dividerColor = computedStyle.getPropertyValue('--divider').trim() || '#3C3C3E';

        // ----- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -----
        resizeCanvas();
        window.addEventListener('resize', debounce(resizeCanvas, 100));
        setupDiscordSdk();
        connectToBackend();

        // ----- –õ–æ–≥–∏–∫–∞ –û—Ç—Ä–∏—Å–æ–≤–∫–∏ –ö–æ–ª–µ—Å–∞ -----
        
        function drawWheel() {
            const size = canvas.width;
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–∫–∏ 'Negative radius' –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏
            if (size <= 20) return; 

            const center = size / 2;
            
            ctx.clearRect(0, 0, size, size);
            
            // –ì–ª–∞–≤–Ω—ã–π —Ñ–∏–∫—Å (v6): –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç, –∞ –Ω–µ CSS
            ctx.save();
            ctx.translate(center, center);
            ctx.rotate(-Math.PI / 2); // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ -90 –≥—Ä–∞–¥—É—Å–æ–≤
            ctx.translate(-center, -center);

            if (participants.length === 0) {
                wheelSubtitle.classList.remove('hidden');
                ctx.beginPath();
                ctx.arc(center, center, center - 5, 0, 2 * Math.PI);
                ctx.fillStyle = '#2C2C2E'; // –¶–≤–µ—Ç –ø—É—Å—Ç–æ–≥–æ –∫–æ–ª–µ—Å–∞
                ctx.fill();
                ctx.restore(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ö–æ–ª—Å—Ç
                return;
            }
            
            wheelSubtitle.classList.add('hidden');
            let startAngle = 0;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            let weightedParticipants = [];
            
            if (gameMode === 'classic') {
                const totalBet = participants.reduce((sum, p) => sum + p.amount, 0);
                if (totalBet > 0) {
                    weightedParticipants = participants.map(p => ({
                        ...p,
                        sliceAngle: (p.amount / totalBet) * 2 * Math.PI
                    }));
                }
            } else {
                // –†–µ–∂–∏–º "–ù–∞ –≤—ã–±—ã–≤–∞–Ω–∏–µ" (–∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Å–∞)
                const totalAmount = participants.reduce((sum, p) => sum + p.amount, 0);
                if (totalAmount > 0) {
                    const weights = participants.map(p => ({ ...p, weight: totalAmount / p.amount }));
                    const totalInverseWeight = weights.reduce((sum, p) => sum + p.weight, 0);
                    
                    if(totalInverseWeight > 0) {
                        weightedParticipants = weights.map(p => ({
                            ...p,
                            sliceAngle: (p.weight / totalInverseWeight) * 2 * Math.PI
                        }));
                    }
                }
            }
            
            // –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å–µ —Å—Ç–∞–≤–∫–∏ 0), –¥–µ–ª–∏–º –ø–æ—Ä–æ–≤–Ω—É
            if (weightedParticipants.length === 0 && participants.length > 0) {
                 weightedParticipants = participants.map(p => ({
                    ...p,
                    sliceAngle: (1 / participants.length) * 2 * Math.PI
                }));
            }

            // –†–∏—Å—É–µ–º —Å–µ–∫—Ç–æ—Ä–∞
            weightedParticipants.forEach(p => {
                const sliceAngle = p.sliceAngle;
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, center - 5, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = p.color;
                ctx.fill();
                
                // –†–∏—Å—É–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏, –µ—Å–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ > 1
                if (participants.length > 1) {
                    ctx.strokeStyle = dividerColor; // –ò—Å–ø–æ–ª—å–∑—É–µ–º JS-–ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
                
                startAngle += sliceAngle;
            });
            
            ctx.restore(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ö–æ–ª—Å—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        }

        function updateParticipantsCardsList() {
            if (participants.length === 0) {
                participantsCardsList.innerHTML = '<p class="text-center pt-8 text-sm text-gray-400">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                spinBtn.disabled = true;
                return;
            }
            
            participantsCardsList.innerHTML = '';
            participants.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'flex items-center p-3 rounded-lg';
                card.style.backgroundColor = 'var(--bg-tertiary)';
                
                card.innerHTML = `
                    <img src="${p.avatarUrl}" class="w-10 h-10 rounded-full mr-3">
                    <div class="flex-grow min-w-0">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2 flex-shrink-0" style="background-color: ${p.color};"></div>
                            <p class="font-bold text-white truncate">${p.name}</p>
                        </div>
                        <p class="text-sm text-gray-400">–°—Ç–∞–≤–∫–∞: ${p.amount}$</p>
                    </div>
                    <button class="ml-2 text-gray-600 hover:text-red-400 font-bold text-lg" data-index="${index}">‚úñ</button>
                `;
                participantsCardsList.appendChild(card);
            });
            
            spinBtn.disabled = isSpinning || participants.length < 2;
        }

        // ----- –õ–æ–≥–∏–∫–∞ –í—Ä–∞—â–µ–Ω–∏—è (—Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º) -----

        function handleSpinClick() {
            if (isSpinning || participants.length < 2 || !ws || ws.readyState !== WebSocket.OPEN) return;
            isSpinning = true;
            spinBtn.disabled = true;
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –°–µ—Ä–≤–µ—Ä —Ä–µ—à–∏—Ç, –∫—Ç–æ –ø–æ–±–µ–¥–∏–ª.
            ws.send(JSON.stringify({ type: 'spin' }));
        }

        function animateSpin(spinAngle, duration) {
            const startTimestamp = performance.now();
            
            function animate(currentTime) {
                const elapsedTime = currentTime - startTimestamp;
                const progress = Math.min(elapsedTime / duration, 1);
                // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è (ease-out cubic)
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const currentAngle = easeProgress * spinAngle;
                
                canvas.style.transform = `rotate(${currentAngle}rad)`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    canvas.style.transform = `rotate(${spinAngle}rad)`;
                }
            }
            
            requestAnimationFrame(animate);
        }

        function handleSpinResult(winner, finalWinner = false) {
            let title, name, subtitle;
            
            if (finalWinner) {
                // –§–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ "–ù–∞ –≤—ã–±—ã–≤–∞–Ω–∏–µ"
                title = '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å!';
                name = `üèÜ ${winner.name} üèÜ`;
                subtitle = '–í—ã–∂–∏–≤—à–∏–π –≤ —ç—Ç–æ–π –±–∏—Ç–≤–µ!';
            } else if (gameMode === 'classic') {
                title = '–ü–æ–±–µ–¥–∏—Ç–µ–ª—å!';
                name = `üéâ ${winner.name} üéâ`;
                subtitle = '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!';
            } else {
                title = '–í—ã–±—ã–≤–∞–µ—Ç...';
                name = `üëé ${winner.name} üëé`;
                subtitle = '–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–≤–µ–∑—ë—Ç –±–æ–ª—å—à–µ!';
            }
            
            showResultPopup(title, name, subtitle);
            
            // –í —Ä–µ–∂–∏–º–µ "–ö–ª–∞—Å—Å–∏–∫–∞" –∏–ª–∏ –µ—Å–ª–∏ —ç—Ç–æ —Ñ–∏–Ω–∞–ª, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–∏–Ω–≥
            if (gameMode === 'classic' || finalWinner) {
                isSpinning = false;
            }
        }
        
        // ----- –ü–æ–ø–∞–ø -----
        function showResultPopup(title, name, subtitle) {
            popupTitle.textContent = title;
            popupName.textContent = name;
            popupSubtitle.textContent = subtitle;
            resultPopup.classList.remove('hidden');
            setTimeout(() => resultPopup.querySelector('div').classList.remove('scale-95', 'opacity-0'), 10);
        }

        function hideResultPopup() {
            resultPopup.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                resultPopup.classList.add('hidden');
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –∏–≥—Ä–∞ –Ω–µ –∑–∞–∫–æ–Ω—á–µ–Ω–∞
                spinBtn.disabled = isSpinning || participants.length < 2;
            }, 300);
        }
        
        // ----- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ù–∞—Å—Ç—Ä–æ–µ–∫ -----
        function sendSettings() {
             if (!ws || ws.readyState !== WebSocket.OPEN) return;
             ws.send(JSON.stringify({
                 type: 'set_settings',
                 data: {
                     duration: parseInt(spinDurationInput.value, 10) || 10,
                     speed: parseInt(spinSpeedInput.value, 10) || 5
                 }
             }));
        }

        // ----- WebSocket (–°–≤—è–∑—å —Å —Å–µ—Ä–≤–µ—Ä–æ–º) -----
        function connectToBackend() {
            if (backendUrl.startsWith('WSS_URL')) {
                console.error("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å URL —Å–µ—Ä–≤–µ—Ä–∞ Glitch!");
                connectionStatus.innerHTML = '‚ö†Ô∏è –û—à–∏–±–∫–∞ URL';
                connectionStatus.classList.remove('text-yellow-400', 'text-green-400');
                connectionStatus.classList.add('text-red-500');
                return;
            }
            
            connectionStatus.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>`;
            connectionStatus.classList.remove('text-green-400', 'text-red-500');
            connectionStatus.classList.add('text-yellow-400');
            
            ws = new WebSocket(backendUrl);

            ws.onopen = () => {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É!');
                connectionStatus.innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                connectionStatus.classList.remove('text-yellow-400', 'text-red-500');
                connectionStatus.classList.add('text-green-400');
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                
                switch (message.type) {
                    case 'update_state':
                        participants = message.participants;
                        updateParticipantsCardsList();
                        drawWheel();
                        break;
                    
                    case 'update_settings':
                        // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                        gameMode = message.data.gameMode || gameMode;
                        gameModeToggle.checked = (gameMode === 'elimination');
                        
                        spinDurationInput.value = message.data.duration || 10;
                        spinSpeedInput.value = message.data.speed || 5;
                        drawWheel(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–µ—Å–æ, —Ç.–∫. —Ä–µ–∂–∏–º –º–æ–≥ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
                        break;
                        
                    case 'spin_result':
                        // –°–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å–ª–∞–ª –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏ —É–≥–æ–ª. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é!
                        animateSpin(message.data.spinAngle, message.data.duration);
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –∫–æ–≥–¥–∞ –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è
                        setTimeout(() => {
                            handleSpinResult(message.data.winner, false);
                        }, message.data.duration);
                        break;
                    
                    case 'final_winner':
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
                        handleSpinResult(message.data.winner, true);
                        break;
                }
            };

            ws.onclose = () => {
                console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
                if (!connectionStatus.textContent.includes('–û—à–∏–±–∫–∞')) {
                    connectionStatus.innerHTML = 'üü° –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    connectionStatus.classList.remove('text-green-400', 'text-red-500');
                    connectionStatus.classList.add('text-yellow-400');
                }
                setTimeout(connectToBackend, 3000);
            };

            ws.onerror = (err) => {
                console.error('–û—à–∏–±–∫–∞ WebSocket: ', err);
                connectionStatus.innerHTML = 'üî¥ –û—à–∏–±–∫–∞';
                connectionStatus.classList.remove('text-yellow-400', 'text-green-400');
                connectionStatus.classList.add('text-red-500');
                ws.close();
            };
        }

        // ----- Discord SDK -----
        async function setupDiscordSdk() {
            const queryParams = new URLSearchParams(window.location.search);
            if (queryParams.get('frame_id') == null) {
                console.log("–ù–µ –≤ Discord. SDK –Ω–µ –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.");
                return;
            };

            discordSdk = new DiscordSDK(clientId);
            await discordSdk.ready();

            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            await discordSdk.commands.authorize({
                client_id: clientId,
                response_type: 'code',
                state: '',
                prompt: 'none',
                scope: ['identify', 'guilds.members.read'],
            });

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Discord
            const { code } = await discordSdk.commands.authenticate({ access_token: null });
            // TODO: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ—Ç 'code' –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            const channel = await discordSdk.commands.getChannel({ channel_id: discordSdk.channelId });
            voiceChannelMembers = channel.voice_members || [];
            
            if (voiceChannelMembers.length > 0) {
                addModeContainer.classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
                document.getElementById('mode-helper').classList.add('hidden');
                addModeToggle.disabled = false;
            }
        }
        
        // ----- –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π -----
        
        // –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
        function handleAddManualParticipant() {
            const name = nameInput.value.trim();
            const amount = parseInt(betInput.value, 10);
            if (name && amount > 0 && ws && ws.readyState === WebSocket.OPEN) {
                const color = baseColors[participants.length % baseColors.length];
                // –ê–≤–∞—Ç–∞—Ä–∫–∞-–∑–∞–≥–ª—É—à–∫–∞
                const avatarUrl = `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(name)}`;
                
                ws.send(JSON.stringify({ 
                    type: 'add_participant', 
                    data: { name, amount, color, avatarUrl } 
                }));
                
                nameInput.value = '';
                betInput.value = '';
                nameInput.focus();
            }
        }
        addParticipantBtn.addEventListener('click', handleAddManualParticipant);
        betInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleAddManualParticipant(); });

        // –ê–≤—Ç–æ-–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
        loadVoiceParticipantsBtn.addEventListener('click', () => {
            if (voiceChannelMembers.length === 0 || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            ws.send(JSON.stringify({ type: 'clear_participants' })); // –°–Ω–∞—á–∞–ª–∞ —á–∏—Å—Ç–∏–º
            
            const betAmount = parseInt(autoBetInput.value, 10) || 100;
            
            voiceChannelMembers.forEach((member, index) => {
                const name = member.nick || member.user.global_name || member.user.username;
                const avatarUrl = member.avatar 
                    ? `https://cdn.discordapp.com/avatars/${member.user.id}/${member.avatar}.png` 
                    : `https://cdn.discordapp.com/embed/avatars/${(BigInt(member.user.id) >> 22n) % 6n}.png`;
                const color = baseColors[index % baseColors.length];
                
                ws.send(JSON.stringify({ 
                    type: 'add_participant', 
                    data: { name, amount: betAmount, color, avatarUrl } 
                }));
            });
        });

        // –ö–Ω–æ–ø–∫–∞ "–ö—Ä—É—Ç–∏—Ç—å!"
        spinBtn.addEventListener('click', handleSpinClick);

        // –ó–∞–∫—Ä—ã—Ç—å –ø–æ–ø–∞–ø
        closePopupBtn.addEventListener('click', hideResultPopup);
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–ø–æ –∫–ª–∏–∫—É –Ω–∞ "X")
        participantsCardsList.addEventListener('click', (e) => {
            const targetButton = e.target.closest('button');
            if (targetButton && targetButton.dataset.index && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'remove_participant', data: { index: targetButton.dataset.index } }));
            }
        });
        
        // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö
        clearParticipantsBtn.addEventListener('click', () => {
             if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'clear_participants' }));
             }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        addModeToggle.addEventListener('change', () => {
            manualControls.classList.toggle('hidden');
            autoControls.classList.toggle('hidden');
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã
        gameModeToggle.addEventListener('change', () => {
            gameMode = gameModeToggle.checked ? 'elimination' : 'classic';
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'set_game_mode', data: { mode: gameMode } }));
            }
        });
        
        // –î–µ–±–∞—É–Ω—Å–µ—Ä—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
        spinDurationInput.addEventListener('change', sendSettings);
        spinSpeedInput.addEventListener('change', sendSettings);

        // ----- –•–µ–ª–ø–µ—Ä—ã -----
        
        // –†–µ—Å–∞–π–∑
        function resizeCanvas() {
            const size = canvasContainer.clientWidth;
            canvas.width = size;
            canvas.height = size;
            drawWheel();
        }

        // –î–µ–±–∞—É–Ω—Å (—á—Ç–æ–±—ã 'resize' –Ω–µ —Å–ø–∞–º–∏–ª)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –µ—Å–ª–∏ —Ç–µ–º–∞ —Å–º–µ–Ω–∏–ª–∞—Å—å
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            bgPrimaryColor = computedStyle.getPropertyValue('--bg-primary').trim() || '#000000';
            dividerColor = computedStyle.getPropertyValue('--divider').trim() || '#3C3C3E';
            drawWheel();
        });

    </script>
</body>
</html>