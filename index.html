<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #36393f;
            color: #dcddde;
        }
        .discord-input {
            background-color: #202225;
            border: 1px solid #101113;
        }
        .discord-button {
            transition: background-color 0.2s ease-in-out;
        }
        .discord-button:hover {
            background-color: #4752c4;
        }
        .winner-popup {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        canvas {
            transform: rotate(-90deg); /* –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª—è - —Å–≤–µ—Ä—Ö—É */
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2f3136;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #202225;
            border-radius: 4px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-7xl mx-auto">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">–ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏</h1>
            <p class="text-lg text-gray-400">–î–æ–±–∞–≤–ª—è–π—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏ –∏—Ö —Å—Ç–∞–≤–∫–∏, —á—Ç–æ–±—ã –∏—Å–ø—ã—Ç–∞—Ç—å —É–¥–∞—á—É!</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 items-start">
            
            <div class="bg-[#2f3136] p-6 rounded-lg shadow-lg order-3 lg:order-1 h-full">
                <h2 class="text-2xl font-semibold text-white mb-4">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
                <div id="participants-cards-list" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-400 text-center pt-8">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                </div>
            </div>

            <div class="relative flex flex-col items-center justify-center order-1 lg:order-2 lg:col-span-2">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-gray-800 border-4 border-gray-900 rounded-full z-20"></div>
                <div class="absolute -top-1 text-4xl" style="z-index: 10;">üîª</div>
                <canvas id="wheel" width="500" height="500"></canvas>
                <button id="spin-button" class="discord-button mt-6 bg-[#4CAF50] text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg disabled:bg-gray-500 disabled:cursor-not-allowed">
                    –ö—Ä—É—Ç–∏—Ç—å!
                </button>
            </div>

            <div class="bg-[#2f3136] p-6 rounded-lg shadow-lg order-2 lg:order-3 h-full">
                <h2 class="text-2xl font-semibold text-white mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                <div class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-300 mb-1">–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                        <input type="text" id="name" class="discord-input w-full p-2 rounded-md text-white focus:ring-2 focus:ring-indigo-500" placeholder="Username#1234">
                    </div>
                    <div>
                        <label for="bet" class="block text-sm font-medium text-gray-300 mb-1">–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏</label>
                        <input type="number" id="bet" class="discord-input w-full p-2 rounded-md text-white focus:ring-2 focus:ring-indigo-500" placeholder="100" min="1">
                    </div>
                    <button id="add-participant" class="discord-button w-full bg-[#5865F2] text-white font-bold py-2 px-4 rounded-md">
                        –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="winner-popup" class="fixed inset-0 winner-popup flex items-center justify-center hidden z-50">
        <div class="bg-[#2f3136] p-8 rounded-lg shadow-xl text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold text-gray-300 mb-2">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å!</h2>
            <p class="text-5xl font-bold text-white mb-4" id="winner-name">üéâ</p>
            <p class="text-lg text-gray-400">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!</p>
            <button id="close-popup" class="mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { DiscordSDK } from 'https://cdn.jsdelivr.net/npm/@discord/embedded-app-sdk@latest/+esm';

        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        const nameInput = document.getElementById('name');
        const betInput = document.getElementById('bet');
        const addParticipantBtn = document.getElementById('add-participant');
        const spinBtn = document.getElementById('spin-button');
        const participantsCardsList = document.getElementById('participants-cards-list');
        const winnerPopup = document.getElementById('winner-popup');
        const winnerNameEl = document.getElementById('winner-name');
        const closePopupBtn = document.getElementById('close-popup');

        let participants = [];
        let totalBet = 0;
        let isSpinning = false;
        
        const baseColors = ['#e6194B', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#42d4f4', '#f032e6', '#bfef45', '#fabed4', '#469990', '#dcbeff', '#9A6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#a9a9a9'];

        function drawWheel() {
            const size = canvas.width;
            const center = size / 2;
            let startAngle = 0;
            ctx.clearRect(0, 0, size, size);

            if (participants.length === 0) {
                ctx.beginPath();
                ctx.arc(center, center, center - 5, 0, 2 * Math.PI);
                ctx.fillStyle = '#4a4d53';
                ctx.fill();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = '#dcddde';
                ctx.font = 'bold 20px Inter';
                ctx.save();
                ctx.rotate(Math.PI/2);
                ctx.fillText('–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', center, -center);
                ctx.restore();
                return;
            }

            participants.forEach(p => {
                const sliceAngle = (p.amount / totalBet) * 2 * Math.PI;
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, center - 5, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = p.color;
                ctx.fill();

                ctx.save();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Inter';
                const textAngle = startAngle + sliceAngle / 2 + Math.PI/2;
                ctx.translate(center, center);
                ctx.rotate(textAngle);
                ctx.textAlign = 'center';
                const displayName = p.name.length > 10 ? p.name.substring(0, 8) + '...' : p.name;
                ctx.fillText(displayName, 0, -center * 0.7);
                ctx.restore();

                startAngle += sliceAngle;
            });
        }
        
        function updateParticipantsCardsList() {
            if (participants.length === 0) {
                participantsCardsList.innerHTML = '<p class="text-gray-400 text-center pt-8">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                spinBtn.disabled = true;
                return;
            }
            
            participantsCardsList.innerHTML = '';
            participants.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'flex items-center bg-[#202225] p-3 rounded-lg transition-transform transform hover:scale-105';
                card.innerHTML = `
                    <img src="${p.avatarUrl}" class="w-12 h-12 rounded-full mr-4 border-2" style="border-color: ${p.color};">
                    <div class="flex-grow">
                        <p class="font-bold text-white truncate">${p.name}</p>
                        <p class="text-sm text-gray-400">–°—Ç–∞–≤–∫–∞: ${p.amount}$</p>
                    </div>
                    <button class="ml-2 text-gray-500 hover:text-red-400" data-index="${index}">‚úñ</button>
                `;
                participantsCardsList.appendChild(card);
            });
            spinBtn.disabled = false;
        }

        function addParticipant(name, amount, avatarUrl) {
            if (name && amount > 0) {
                const color = baseColors[participants.length % baseColors.length];
                const finalAvatarUrl = avatarUrl || `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(name)}`;
                
                participants.push({ name, amount, color, avatarUrl: finalAvatarUrl });
                totalBet += amount;
                                
                updateParticipantsCardsList();
                drawWheel();
            }
        }
        
        function handleAddManualParticipant() {
            const name = nameInput.value.trim();
            const amount = parseInt(betInput.value, 10);
             if (name && amount > 0) {
                 addParticipant(name, amount);
                 nameInput.value = '';
                 betInput.value = '';
                 nameInput.focus();
             } else {
                nameInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(() => nameInput.classList.remove('ring-2', 'ring-red-500'), 2000);
            }
        }

        function removeParticipant(index) {
            const removed = participants.splice(index, 1)[0];
            totalBet -= removed.amount;
            updateParticipantsCardsList();
            drawWheel();
        }
        
        function spin() {
            if (isSpinning || participants.length < 1) return;
            isSpinning = true;
            spinBtn.disabled = true;

            const spinAngle = Math.random() * 10 + 10;
            const startTimestamp = performance.now();
            const duration = 5000;

            function animate(currentTime) {
                const elapsedTime = currentTime - startTimestamp;
                const progress = Math.min(elapsedTime / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                const currentAngle = easeProgress * spinAngle;
                canvas.style.transform = `rotate(${currentAngle}rad)`;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    canvas.style.transform = `rotate(${spinAngle}rad)`;
                    const finalAngle = spinAngle % (2 * Math.PI);
                    const pointerAngle = (finalAngle + Math.PI / 2) % (2 * Math.PI);
                    
                    let accumulatedAngle = 0;
                    for (const p of participants) {
                        const sliceAngle = (p.amount / totalBet) * 2 * Math.PI;
                        if (pointerAngle >= accumulatedAngle && pointerAngle < accumulatedAngle + sliceAngle) {
                            showWinner(p);
                            break;
                        }
                        accumulatedAngle += sliceAngle;
                    }
                    isSpinning = false;
                }
            }
            requestAnimationFrame(animate);
        }
        
        function showWinner(winner) {
            winnerNameEl.textContent = `üéâ ${winner.name} üéâ`;
            winnerPopup.classList.remove('hidden');
            setTimeout(() => {
                winnerPopup.querySelector('div').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideWinner() {
            winnerPopup.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                winnerPopup.classList.add('hidden');
                spinBtn.disabled = false;
            }, 300);
        }

        addParticipantBtn.addEventListener('click', handleAddManualParticipant);
        betInput.addEventListener('keydown', (e) => {
             if (e.key === 'Enter') handleAddManualParticipant();
        });
        spinBtn.addEventListener('click', spin);
        closePopupBtn.addEventListener('click', hideWinner);
        
        participantsCardsList.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON') {
                const index = e.target.dataset.index;
                removeParticipant(index);
            }
        });
        
        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Discord SDK ---
        const clientId = 'YOUR_CLIENT_ID'; 
        let discordSdk;

        async function setupDiscordSdk() {
            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ Discord ---
            const queryParams = new URLSearchParams(window.location.search);
            if (queryParams.get('frame_id') == null) {
                console.warn("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω–µ Discord. SDK –Ω–µ –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.");
                // –ü–æ–∑–≤–æ–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —Ä–∞–±–æ—Ç–∞—Ç—å –≤ "—Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ" –±–µ–∑ SDK
                return;
            }
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

            try {
                discordSdk = new DiscordSDK(clientId);
                await discordSdk.ready();

                const { code } = await discordSdk.commands.authorize({
                    client_id: clientId,
                    response_type: 'code',
                    state: '',
                    prompt: 'none',
                    scope: ['identify', 'guilds.members.read'],
                });
                
                const channel = await discordSdk.commands.getChannel({channel_id: discordSdk.channelId});
                
                console.log("–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–º –∫–∞–Ω–∞–ª–µ:", channel.voice_members);

            } catch(e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Discord SDK:", e);
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        drawWheel();
        updateParticipantsCardsList();
        setupDiscordSdk();

    </script>
</body>
</html>

