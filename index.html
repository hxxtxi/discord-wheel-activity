<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º —à—Ä–∏—Ñ—Ç Inter, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π —à—Ä–∏—Ñ—Ç Apple (San Francisco) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Apple Dark Mode Palette */
            --bg-primary: #1C1C1E;    /* –ü–æ—á—Ç–∏ —á–µ—Ä–Ω—ã–π, —Ñ–æ–Ω */
            --bg-secondary: #2C2C2E;  /* –°–µ—Ä—ã–π, —Ñ–æ–Ω –ø–∞–Ω–µ–ª–µ–π */
            --bg-tertiary: #3A3A3C;   /* –°–≤–µ—Ç–ª–µ–µ —Å–µ—Ä—ã–π, –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ */
            --text-primary: #FFFFFF;
            --text-secondary: #EBEBF599; /* 60% –±–µ–ª—ã–π */
            --text-tertiary: #EBEBF54D;  /* 30% –±–µ–ª—ã–π */
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-red: #FF453A;
            --divider: rgba(84, 84, 88, 0.65); /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
        }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-secondary); 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç "Frosted Glass" (–†–∞–∑–º—ã—Ç–æ–µ —Å—Ç–µ–∫–ª–æ) –¥–ª—è –ø–∞–Ω–µ–ª–µ–π */
        .apple-panel { 
            background-color: rgba(44, 44, 46, 0.75); /* var(--bg-secondary) —Å 75% –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(84, 84, 88, 0.5); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* –°—Ç–∏–ª–∏ –∏–Ω–ø—É—Ç–æ–≤ */
        .apple-input { 
            background-color: var(--bg-tertiary); 
            border: 1px solid var(--divider); 
            color: var(--text-primary); 
            caret-color: var(--accent-blue);
        }
        .apple-input::placeholder { color: var(--text-tertiary); }
        .apple-input:focus { 
            outline: none; 
            border-color: var(--accent-blue); 
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.3);
        }
        
        /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
        .apple-button-brand { 
            background-color: var(--accent-blue); 
            color: var(--text-primary); 
            font-weight: 600;
            transition: transform 0.1s cubic-bezier(0.3, 0, 0.5, 1), background-color 0.2s;
        }
        .apple-button-brand:hover { background-color: #3895ff; }
        .apple-button-brand:active { transform: scale(0.96); }
        
        .apple-button-spin { 
            background-color: var(--accent-green); 
            color: #1C1C1E; /* –¢–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–∞ —è—Ä–∫–æ–π –∫–Ω–æ–ø–∫–µ */
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(48, 209, 88, 0.3);
            transition: transform 0.1s cubic-bezier(0.3, 0, 0.5, 1), background-color 0.2s;
        }
        .apple-button-spin:hover { background-color: #4be06e; }
        .apple-button-spin:active { transform: scale(0.96); }
        .apple-button-spin:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-tertiary);
            box-shadow: none;
            cursor: not-allowed;
        }
        
        /* –ü–æ–ø–∞–ø */
        .winner-popup { 
            background-color: rgba(10, 10, 10, 0.4); 
            backdrop-filter: blur(8px) saturate(150%);
            -webkit-backdrop-filter: blur(8px) saturate(150%);
        }

        /* –¢–µ–Ω—å –¥–ª—è –∫–æ–ª–µ—Å–∞ */
        .wheel-shadow {
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.25));
        }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #4a4a4c; }
        
        /* iOS-style –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å */
        .toggle-bg {
            background-color: var(--bg-tertiary);
            transition: background-color 0.2s ease-in-out;
        }
        .toggle:checked + .toggle-bg {
            background-color: var(--accent-blue);
        }
        .toggle:checked + .toggle-bg .toggle-dot {
            transform: translateX(100%);
        }
        .toggle-dot {
            background-color: white;
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        /* –°–∫—Ä—ã—Ç–∏–µ "—Å—Ç—Ä–µ–ª–æ–∫" —É –∏–Ω–ø—É—Ç–∞ —Å —á–∏—Å–ª–æ–º */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }

    </style>
</head>
<body class="flex items-center justify-center min-h-screen w-full h-full p-4 box-border">
    
    <div class="w-full max-w-7xl mx-auto h-full">
        <!-- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞: 1 –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö, 4 –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 items-start h-full">
            
            <!-- –ü–∞–Ω–µ–ª—å –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–õ–µ–≤–∞—è) -->
            <div class="apple-panel p-4 rounded-2xl shadow-lg order-2 lg:order-1 h-full lg:max-h-[85vh]">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
                    <button id="clear-all-btn" class="text-sm text-blue-500 hover:text-blue-400 active:scale-95 transition-all">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
                </div>
                <div id="participants-cards-list" class="space-y-3 max-h-[40vh] lg:max-h-[calc(85vh-80px)] overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-center pt-8">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
                </div>
            </div>

            <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –ö–æ–ª–æ–Ω–∫–∞ (–ö–æ–ª–µ—Å–æ) -->
            <div class="flex flex-col items-center justify-center order-1 lg:order-2 lg:col-span-2 h-full flex-grow">
                <h1 class="text-3xl font-bold text-white mb-2">–ö–æ–ª–µ—Å–æ –£–¥–∞—á–∏</h1>
                <p id="wheel-subtitle" class="text-lg text-gray-400 -mt-2 mb-2 transition-opacity duration-300 opacity-0">–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                
                <div class="relative w-full max-w-[500px] aspect-square mx-auto">
                    <!-- –ß–µ—Ä–µ–ø üíÄ -->
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-5xl z-20" style="filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));">üíÄ</div>
                    <!-- –°—Ç—Ä–µ–ª–∫–∞-—É–∫–∞–∑–∞—Ç–µ–ª—å -->
                    <div class="absolute -top-1 left-1/2 -translate-x-1/2 text-4xl z-10" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.4));">üîª</div>
                    <!-- –ö–∞–Ω–≤–∞—Å -->
                    <canvas id="wheel" class="w-full h-full wheel-shadow"></canvas>
                </div>
                
                <button id="spin-button" classs="apple-button-spin mt-6 font-bold py-3 px-10 rounded-lg text-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    –ö—Ä—É—Ç–∏—Ç—å!
                </button>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –ù–∞—Å—Ç—Ä–æ–µ–∫ (–ü—Ä–∞–≤–∞—è) -->
            <div class="apple-panel p-4 rounded-2xl shadow-lg order-3 lg:order-3 h-full lg:max-h-[85vh]">
                <h2 class="text-xl font-semibold text-white mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ò–≥—Ä—ã</h2>
                
                <!-- –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ -->
                <div class="mb-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-semibold text-white">–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞</label>
                        <div id="connection-status" class="text-sm font-bold text-yellow-400 flex items-center">
                            <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                        </div>
                    </div>
                </div>
                <hr class="border-[var(--divider)] mb-4">
                
                <div class="space-y-4">
                    <!-- –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                    <div>
                        <label class="text-sm font-semibold text-white">–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</label>
                        <label id="mode-label" for="add-mode-toggle" class="flex items-center justify-between mt-2 opacity-50">
                            <span class="text-sm">–í—Ä—É—á–Ω—É—é / –ò–∑ –∫–∞–Ω–∞–ª–∞</span>
                            <div class="relative">
                                <input type="checkbox" id="add-mode-toggle" class="sr-only toggle" disabled>
                                <div class="toggle-bg w-11 h-6 rounded-full">
                                    <div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div>
                                </div>
                            </div>
                        </label>
                        <p id="mode-helper" class="text-xs text-gray-500 mt-1">–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Discord</p>
                    </div>

                    <!-- –†–µ–∂–∏–º –∏–≥—Ä—ã -->
                     <div>
                        <label class="text-sm font-semibold text-white">–†–µ–∂–∏–º –∏–≥—Ä—ã</label>
                        <label for="game-mode-toggle" class="flex items-center justify-between mt-2">
                            <span class="text-sm">–ö–ª–∞—Å—Å–∏–∫–∞ / –ù–∞ –≤—ã–±—ã–≤–∞–Ω–∏–µ</span>
                            <div class="relative">
                                <input type="checkbox" id="game-mode-toggle" class="sr-only toggle">
                                <div class="toggle-bg w-11 h-6 rounded-full">
                                    <div class="toggle-dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full"></div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <!-- –í—Ä–µ–º—è –≤—Ä–∞—â–µ–Ω–∏—è -->
                    <div>
                        <label for="spin-duration" class="block text-sm font-semibold text-white mb-2">–í—Ä–µ–º—è –≤—Ä–∞—â–µ–Ω–∏—è (—Å–µ–∫)</label>
                        <input type="number" id="spin-duration" class="apple-input w-full p-2 rounded-lg" value="10" min="1" max="360">
                    </div>
                    
                    <!-- –°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è -->
                    <div>
                        <label for="spin-speed" class="block text-sm font-semibold text-white mb-2">–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è</label>
                        <input type="range" id="spin-speed" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer" min="10" max="100" value="50">
                    </div>

                    <hr class="border-[var(--divider)] my-4">

                    <!-- –ü–∞–Ω–µ–ª—å —Ä—É—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div id="manual-controls" class="space-y-4">
                        <label class="text-sm font-semibold text-white">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</label>
                        <input type="text" id="name" class="apple-input w-full p-2 rounded-lg" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞">
                        <input type="number" id="bet" class="apple-input w-full p-2 rounded-lg" placeholder="–°—É–º–º–∞ —Å—Ç–∞–≤–∫–∏" min="1">
                        <button id="add-participant" class="apple-button-brand w-full py-2 px-4 rounded-lg">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>

                    <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div id="auto-controls" class="hidden space-y-4">
                        <label class="text-sm font-semibold text-white">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –∫–∞–Ω–∞–ª–∞</label>
                        <input type="number" id="auto-bet" class="apple-input w-full p-2 rounded-lg" value="100" min="1" placeholder="–°—Ç–∞–≤–∫–∞ –¥–ª—è –≤—Å–µ—Ö">
                        <button id="load-voice-participants" class="apple-button-brand w-full py-2 px-4 rounded-lg">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü–æ–ø–∞–ø –ü–æ–±–µ–¥–∏—Ç–µ–ª—è -->
    <div id="result-popup" class="fixed inset-0 winner-popup flex items-center justify-center hidden z-50 p-4">
        <div class="apple-panel p-8 rounded-2xl shadow-xl text-center transform transition-all scale-95 opacity-0 max-w-sm w-full">
            <h2 id="popup-title" class="text-2xl font-bold text-gray-300 mb-2"></h2>
            <p class="text-5xl font-bold text-white mb-4" id="popup-name"></p>
            <p id="popup-subtitle" class="text-lg text-gray-400"></p>
            <button id="close-popup" class="mt-6 apple-button-brand font-bold py-2 px-6 rounded-lg">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { DiscordSDK } from 'https://cdn.jsdelivr.net/npm/@discord/embedded-app-sdk@latest/+esm';
        
        // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL –°–ï–†–í–ï–†–ê (Glitch, Replit –∏ —Ç.–¥.)
        // WSS://<your-project-name>.glitch.me
        const backendUrl = 'WSS_URL_–í–ê–®–ï–ì–û_–°–ï–†–í–ï–†–ê_GLITCH'; 
        let ws;

        // --- UI Elements ---
        const canvas = document.getElementById('wheel');
        const canvasContainer = canvas.parentElement;
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spin-button');
        const participantsCardsList = document.getElementById('participants-cards-list');
        const clearAllBtn = document.getElementById('clear-all-btn'); 
        const wheelSubtitle = document.getElementById('wheel-subtitle');
        const resultPopup = document.getElementById('result-popup');
        const popupTitle = document.getElementById('popup-title');
        const popupName = document.getElementById('popup-name');
        const popupSubtitle = document.getElementById('popup-subtitle');
        const closePopupBtn = document.getElementById('close-popup');
        const spinDurationInput = document.getElementById('spin-duration');
        const spinSpeedInput = document.getElementById('spin-speed');
        const connectionStatus = document.getElementById('connection-status');

        // --- Controls ---
        const addModeToggle = document.getElementById('add-mode-toggle');
        const gameModeToggle = document.getElementById('game-mode-toggle');
        const manualControls = document.getElementById('manual-controls');
        const autoControls = document.getElementById('auto-controls');
        const nameInput = document.getElementById('name');
        const betInput = document.getElementById('bet');
        const addParticipantBtn = document.getElementById('add-participant');
        const autoBetInput = document.getElementById('auto-bet');
        const loadVoiceParticipantsBtn = document.getElementById('load-voice-participants');

        // --- State ---
        let participants = [];
        let isSpinning = false;
        let voiceChannelMembers = [];
        let gameMode = 'classic'; // 'classic' or 'elimination'
        let offlineMode = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        
        // –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ (—è—Ä–∫–∏–µ, –≤ —Å—Ç–∏–ª–µ Apple)
        const baseColors = ['#0A84FF', '#FF453A', '#30D158', '#FF9F0A', '#AF52DE', '#FFD60A', '#5E5CE6', '#64D2FF', '#FF2D55'];

        // --- Canvas & Drawing ---

        let resizeTimeout;
        function resizeCanvas() {
            // "Debounce" –¥–ª—è resize, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const size = Math.floor(canvasContainer.clientWidth);
                
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω—É–ª–µ–≤–æ–≥–æ –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
                if (size <= 0) return;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º "—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π" —Ä–∞–∑–º–µ—Ä –∫–∞–Ω–≤–∞—Å–∞ (—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
                canvas.width = size;
                canvas.height = size;
                
                // –°–Ω–æ–≤–∞ —Ä–∏—Å—É–µ–º –∫–æ–ª–µ—Å–æ –≤ –Ω–æ–≤–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
                drawWheel();
            }, 100);
        }

        function drawWheel() {
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–æ–º
            if (participants.length === 0) {
                wheelSubtitle.classList.remove('opacity-0');
            } else {
                wheelSubtitle.classList.add('opacity-0');
            }
            
            const size = canvas.width;
            
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–∫–∏ 'Negative radius' –ø—Ä–∏ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–º –æ–∫–Ω–µ
            if (size < 20) return; 

            const center = size / 2;
            let startAngle = 0;
            
            // –û—á–∏—â–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç
            ctx.clearRect(0, 0, size, size);
            ctx.save(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞ (–¥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞)
            
            // [–§–ò–ö–° v6] –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç –Ω–∞ -90 –≥—Ä–∞–¥—É—Å–æ–≤, —á—Ç–æ–±—ã 0 –±—ã–ª "–Ω–∞–≤–µ—Ä—Ö—É"
            ctx.translate(center, center);
            ctx.rotate(-Math.PI / 2);
            ctx.translate(-center, -center);

            // –ï—Å–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ—Ç, —Ä–∏—Å—É–µ–º "–ø—É—Å—Ç–æ–µ" –∫–æ–ª–µ—Å–æ
            if (participants.length === 0) {
                ctx.beginPath();
                ctx.arc(center, center, center - 5, 0, 2 * Math.PI);
                ctx.fillStyle = '#4a4d53'; // –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                ctx.fill();
                ctx.restore(); // [–§–ò–ö–°] –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç
                return;
            }

            // [–§–ò–ö–° v5] –°—á–∏—Ç–∞–µ–º totalBet/Weight –ø—Ä—è–º–æ –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞
            let totalWeight = 0;
            let weights = [];

            if (gameMode === 'classic') {
                totalWeight = participants.reduce((sum, p) => sum + p.amount, 0);
                weights = participants.map(p => p.amount);
            } else {
                // "–ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" —Ä–µ–∂–∏–º
                const totalBet = participants.reduce((sum, p) => sum + p.amount, 0);
                if (totalBet > 0) {
                    weights = participants.map(p => totalBet / p.amount);
                    totalWeight = weights.reduce((sum, w) => sum + w, 0);
                }
            }

            if (totalWeight <= 0) {
                 ctx.restore(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
                 return;
            }

            // –†–∏—Å—É–µ–º —Å–µ–∫—Ç–æ—Ä–∞
            participants.forEach((p, index) => {
                const sliceAngle = (weights[index] / totalWeight) * 2 * Math.PI;
                
                // –°–µ–∫—Ç–æ—Ä
                ctx.beginPath();
                ctx.moveTo(center, center);
                ctx.arc(center, center, center - 5, startAngle, startAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = p.color;
                ctx.fill();
                
                // [–§–ò–ö–° v3] –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ > 1 —É—á–∞—Å—Ç–Ω–∏–∫–∞)
                if (participants.length > 1) {
                    ctx.strokeStyle = var(--bg-primary); // –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }

                startAngle += sliceAngle;
            });
            
            ctx.restore(); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ö–æ–ª—Å—Ç –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–¥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞)
        }
        
        // --- UI & State Updates ---

        function updateParticipantsCardsList() {
            if (participants.length === 0) {
                participantsCardsList.innerHTML = '<p class="text-center pt-8 text-gray-500">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
                spinBtn.disabled = true;
                return;
            }

            participantsCardsList.innerHTML = '';
            participants.forEach((p, index) => {
                const card = document.createElement('div');
                card.className = 'flex items-center p-3 rounded-xl transition-transform transform hover:scale-105';
                card.style.backgroundColor = 'var(--bg-tertiary)';
                
                // [–§–ò–ö–° v3] –ö–∞—Ä—Ç–æ—á–∫–∞ —Å —Ü–≤–µ—Ç–Ω–æ–π —Ç–æ—á–∫–æ–π, –∞ –Ω–µ —Ä–∞–º–∫–æ–π
                card.innerHTML = `
                    <img src="${p.avatarUrl}" class="w-10 h-10 rounded-full mr-3">
                    <div class="flex-grow min-w-0">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-2 flex-shrink-0" style="background-color: ${p.color};"></div>
                            <p class="font-semibold text-white truncate">${p.name}</p>
                        </div>
                        <p class="text-sm text-gray-400">–°—Ç–∞–≤–∫–∞: ${p.amount}$</p>
                    </div>
                    <button class="ml-2 text-gray-600 hover:text-red-500 transition-colors" data-index="${index}">‚úñ</button>`;
                
                participantsCardsList.appendChild(card);
            });
            
            // –ù–µ –¥–∞–µ–º –∫—Ä—É—Ç–∏—Ç—å, –µ—Å–ª–∏ < 2 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ò–õ–ò –∏–¥–µ—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            spinBtn.disabled = participants.length < 2 || isSpinning;
        }

        function showResultPopup(title, name, subtitle) {
            popupTitle.textContent = title;
            popupName.innerHTML = name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è —ç–º–æ–¥–∑–∏
            popupSubtitle.textContent = subtitle;
            resultPopup.classList.remove('hidden');
            setTimeout(() => {
                resultPopup.querySelector('div').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideResultPopup() {
            resultPopup.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                resultPopup.classList.add('hidden');
            }, 300);
        }
        
        // --- Game Logic ---

        function handleAddManualParticipant() {
            const name = nameInput.value.trim();
            const amount = parseInt(betInput.value, 10);
            if (name && amount > 0) {
                const color = baseColors[participants.length % baseColors.length];
                const avatarUrl = `https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(name)}`;
                
                const participantData = { name, amount, color, avatarUrl, id: name }; // id –¥–ª—è –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–∞

                if (offlineMode) {
                    // –û—Ñ–ª–∞–π–Ω-–ª–æ–≥–∏–∫–∞
                    participants.push(participantData);
                    updateParticipantsCardsList();
                    drawWheel();
                } else {
                    // –û–Ω–ª–∞–π–Ω-–ª–æ–≥–∏–∫–∞
                    ws.send(JSON.stringify({ type: 'add_participant', data: participantData }));
                }
                
                nameInput.value = '';
                betInput.value = '';
                nameInput.focus();
            }
        }

        function spin() {
            if (isSpinning || participants.length < 2) return;
            
            isSpinning = true;
            spinBtn.disabled = true;
            
            const duration = (parseInt(spinDurationInput.value, 10) || 10) * 1000;
            const speedMultiplier = (parseInt(spinSpeedInput.value, 10) || 50); // –æ—Ç 10 –¥–æ 100
            
            // [–§–ò–ö–° v5] –°—á–∏—Ç–∞–µ–º totalBet/Weight –ø—Ä—è–º–æ –∑–¥–µ—Å—å
            let totalWeight = 0;
            let weights = [];
            
            if (gameMode === 'classic') {
                totalWeight = participants.reduce((sum, p) => sum + p.amount, 0);
                weights = participants.map(p => p.amount);
            } else {
                // "–ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π" —Ä–µ–∂–∏–º
                const totalBet = participants.reduce((sum, p) => sum + p.amount, 0);
                weights = participants.map(p => (totalBet > 0 ? totalBet / p.amount : 1));
                totalWeight = weights.reduce((sum, w) => sum + w, 0);
            }
            
            if (totalWeight <= 0) {
                isSpinning = false;
                spinBtn.disabled = false;
                return;
            }

            // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º)
            const randomValue = Math.random() * totalWeight;
            let accumulatedWeight = 0;
            let result = participants[0]; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–µ—Ä–≤—ã–π

            for (let i = 0; i < participants.length; i++) {
                accumulatedWeight += weights[i];
                if (randomValue <= accumulatedWeight) {
                    result = participants[i];
                    break;
                }
            }

            // --- –õ–æ–≥–∏–∫–∞ –ê–Ω–∏–º–∞—Ü–∏–∏ ---
            // –ù–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —Å—Ç—Ä–µ–ª–∫–∞ `üîª` —É–∫–∞–∑–∞–ª–∞ –Ω–∞ –°–ï–†–ï–î–ò–ù–£ —Å–µ–∫—Ç–æ—Ä–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è.
            
            let resultAngle = 0;
            let accumulatedAngle = 0;

            for (let i = 0; i < participants.length; i++) {
                const sliceAngle = (weights[i] / totalWeight) * 2 * Math.PI;
                if (participants[i].id === result.id) {
                    resultAngle = accumulatedAngle + (sliceAngle / 2); // –¶–µ–ª—å - —Å–µ—Ä–µ–¥–∏–Ω–∞ —Å–µ–∫—Ç–æ—Ä–∞
                    break;
                }
                accumulatedAngle += sliceAngle;
            }

            // [–§–ò–ö–° v6]
            // `spinAngle` - —ç—Ç–æ –¢–û, –ö–£–î–ê –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–∑–µ–º–ª–∏—Ç—å—Å—è –∫–æ–ª–µ—Å–æ (–≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö).
            // –ú—ã —Ö–æ—Ç–∏–º, —á—Ç–æ–±—ã `resultAngle` –æ–∫–∞–∑–∞–ª—Å—è –Ω–∞–≤–µ—Ä—Ö—É (–ø–æ–¥ `üîª`).
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫—Ä—É—Ç–∏—Ç `transform: rotate()`. 0 - —ç—Ç–æ 3 —á–∞—Å–∞.
            // –ù–∞—à–∞ —Å—Ç—Ä–µ–ª–∫–∞ `üîª` - —ç—Ç–æ 12 —á–∞—Å–æ–≤ (–∏–ª–∏ -90deg / -PI/2).
            // `finalAngle` - —ç—Ç–æ –∫—É–¥–∞ –¥–æ–ª–∂–µ–Ω —É–∫–∞–∑–∞—Ç—å `resultAngle` –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û 3-—Ö —á–∞—Å–æ–≤.
            // –ù–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã `resultAngle` —Å—Ç–∞–ª `-PI/2`.
            // `spinAngle` = (–ü–æ–ª–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã) + (–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É `resultAngle` –∏ `-PI/2`)
            // `finalAngle = -resultAngle` (–ø–æ—Ç–æ–º—É —á—Ç–æ –º—ã –∫—Ä—É—Ç–∏–º –∫–æ–ª–µ—Å–æ, –∞ –Ω–µ —Å—Ç—Ä–µ–ª–∫—É)
            
            const totalRotations = (speedMultiplier / 10) + 5; // 5-15 –æ–±–æ—Ä–æ—Ç–æ–≤
            const spinAngle = (totalRotations * 2 * Math.PI) - resultAngle;
            
            const startTimestamp = performance.now();

            function animate(currentTime) {
                const elapsedTime = currentTime - startTimestamp;
                const progress = Math.min(elapsedTime / duration, 1);
                // –ü–ª–∞–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ (ease-out cubic)
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                const currentAngle = easeProgress * spinAngle;
                canvas.style.transform = `rotate(${currentAngle}rad)`;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                    canvas.style.transform = `rotate(${spinAngle}rad)`;
                    handleSpinResult(result);
                }
            }

            requestAnimationFrame(animate);
        }

        function handleSpinResult(result) {
            // `result` - —ç—Ç–æ —Ç–æ—Ç, –Ω–∞ –∫–æ–≥–æ –£–ö–ê–ó–ê–õ–ê —Å—Ç—Ä–µ–ª–∫–∞
            
            if (gameMode === 'classic') {
                // –í "–ö–ª–∞—Å—Å–∏–∫–µ" –æ–Ω –ü–û–ë–ï–ñ–î–ê–ï–¢
                showResultPopup('–ü–æ–±–µ–¥–∏—Ç–µ–ª—å!', `üéâ ${result.name} üéâ`, '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–æ–±–µ–¥–æ–π!');
                isSpinning = false;
                spinBtn.disabled = participants.length < 2;
                
            } else if (gameMode === 'elimination') {
                // –í "–ù–∞ –≤—ã–±—ã–≤–∞–Ω–∏–µ" –æ–Ω –í–´–ë–´–í–ê–ï–¢
                
                if (participants.length > 2) {
                    // –ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
                    showResultPopup('–í—ã–±—ã–≤–∞–µ—Ç...', `üëé ${result.name} üëé`, '–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–≤–µ–∑—ë—Ç –±–æ–ª—å—à–µ!');
                    
                    // [–§–ò–ö–° v3] –£–¥–∞–ª—è–µ–º –∏–≥—Ä–æ–∫–∞ –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                    setTimeout(() => {
                        if (offlineMode) {
                            participants = participants.filter(p => p.id !== result.id);
                            drawWheel();
                            updateParticipantsCardsList();
                        } else {
                             ws.send(JSON.stringify({ type: 'eliminate_participant', data: { id: result.id } }));
                        }
                        isSpinning = false;
                    }, 500); // –î–∞–µ–º –≤—Ä–µ–º—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ø–∞–ø

                } else {
                    // –≠—Ç–æ –±—ã–ª –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞—É–Ω–¥, –æ—Å—Ç–∞–ª—Å—è 1 –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
                    const winner = participants.find(p => p.id !== result.id);
                    showResultPopup('–ü–æ–±–µ–¥–∏—Ç–µ–ª—å!', `üèÜ ${winner.name} üèÜ`, '–í—ã–∂–∏–≤—à–∏–π –≤ —ç—Ç–æ–π –±–∏—Ç–≤–µ!');
                    
                    // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–≥–æ
                    setTimeout(() => {
                         if (offlineMode) {
                            participants = participants.filter(p => p.id !== result.id);
                            drawWheel();
                            updateParticipantsCardsList();
                        } else {
                             ws.send(JSON.stringify({ type: 'eliminate_participant', data: { id: result.id } }));
                        }
                        isSpinning = false;
                    }, 500);
                }
            }
        }
        
        function clearAllParticipants() {
            if (offlineMode) {
                participants = [];
                updateParticipantsCardsList();
                drawWheel();
            } else {
                ws.send(JSON.stringify({ type: 'clear_participants' }));
            }
        }

        // --- WebSocket (Backend) Logic ---

        function connectToBackend() {
            if (backendUrl.startsWith('WSS_URL')) {
                console.warn("URL —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω. –ó–∞–ø—É—Å–∫ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ.");
                offlineMode = true;
                connectionStatus.innerHTML = '‚ö†Ô∏è –û—Ñ–ª–∞–π–Ω-—Ç–µ—Å—Ç';
                connectionStatus.className = "text-sm font-bold text-yellow-400 flex items-center";
                return;
            }
            
            offlineMode = false;
            connectionStatus.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>`;
            connectionStatus.className = "text-sm font-bold text-yellow-400 flex items-center";
            
            ws = new WebSocket(backendUrl);

            ws.onopen = () => {
                console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É!');
                connectionStatus.innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                connectionStatus.className = "text-sm font-bold text-green-400 flex items-center";
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'update_state') {
                    participants = message.participants;
                    // –ú—ã –¥–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä—É, —á—Ç–æ totalBet/Weight –ø–æ—Å—á–∏—Ç–∞–Ω—ã –≤–µ—Ä–Ω–æ
                    updateParticipantsCardsList();
                    drawWheel();
                }
                // TODO: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É 'spin_result' –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
            };

            ws.onclose = () => {
                console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
                if (!connectionStatus.textContent.includes('–û—à–∏–±–∫–∞')) {
                    connectionStatus.innerHTML = 'üü° –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    connectionStatus.className = "text-sm font-bold text-yellow-400 flex items-center";
                }
                setTimeout(connectToBackend, 3000);
            };

            ws.onerror = (err) => {
                console.error('–û—à–∏–±–∫–∞ WebSocket: –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ü–µ—Ä–µ—Ö–æ–¥ –≤ –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º.');
                connectionStatus.innerHTML = 'üî¥ –û—à–∏–±–∫–∞. –û—Ñ–ª–∞–π–Ω-—Ç–µ—Å—Ç';
                connectionStatus.className = "text-sm font-bold text-red-400 flex items-center";
                ws.close();
                offlineMode = true; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ –æ—Ñ–ª–∞–π–Ω, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–ø–∞–ª
            };
        }

        // --- Discord SDK (Client) Logic ---
        
        // [–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û] –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ Client ID –≤–∞—à–µ–≥–æ Discord –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const clientId = '1292015094247264307'; 
        
        async function setupDiscordSdk() {
            const queryParams = new URLSearchParams(window.location.search);
            if (queryParams.get('frame_id') == null) {
                console.log("–ù–µ –≤ Discord. SDK –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω.");
                return; // –ù–µ –≤ Discord
            }
            
            const discordSdk = new DiscordSDK(clientId);
            await discordSdk.ready();
            
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –≥–∏–ª—å–¥–∏–∏
            try {
                const { code } = await discordSdk.commands.authorize({
                    client_id: clientId,
                    response_type: 'code',
                    state: '',
                    prompt: 'none',
                    scope: ['identify', 'guilds.members.read'],
                });
                
                // (–î–ª—è –±—É–¥—É—â–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä
                // ws.send(JSON.stringify({ type: 'authorize', code: code }));

                // –ü–æ–ª—É—á–∞–µ–º –∫–∞–Ω–∞–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–ø—É—â–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
                const channel = await discordSdk.commands.getChannel({ channel_id: discordSdk.channelId });
                if (channel.voice_members) {
                    voiceChannelMembers = channel.voice_members;
                }

                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º UI, –µ—Å–ª–∏ –º—ã –≤ Discord
                if (voiceChannelMembers.length > 0) {
                    const modeLabel = document.getElementById('mode-label');
                    modeLabel.classList.remove('opacity-50');
                    modeLabel.style.cursor = 'pointer';
                    addModeToggle.disabled = false;
                    document.getElementById('mode-helper').classList.add('hidden');
                }
                
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Discord SDK:", err);
            }
        }

        // --- Event Listeners ---

        addParticipantBtn.addEventListener('click', handleAddManualParticipant);
        betInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleAddManualParticipant(); });
        spinBtn.addEventListener('click', spin);
        closePopupBtn.addEventListener('click', hideResultPopup);
        clearAllBtn.addEventListener('click', clearAllParticipants);
        
        participantsCardsList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.index) {
                const index = parseInt(button.dataset.index, 10);
                if (offlineMode) {
                    participants.splice(index, 1);
                    updateParticipantsCardsList();
                    drawWheel();
                } else {
                    const participantId = participants[index].id;
                    ws.send(JSON.stringify({ type: 'remove_participant', data: { id: participantId } }));
                }
            }
        });

        addModeToggle.addEventListener('change', () => {
            // [–§–ò–ö–° v3] –ù–µ –æ—á–∏—â–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞
            manualControls.classList.toggle('hidden');
            autoControls.classList.toggle('hidden');
        });

        gameModeToggle.addEventListener('change', () => {
            gameMode = gameModeToggle.checked ? 'elimination' : 'classic';
            // [–§–ò–ö–° v4] –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–µ—Å–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            isSpinning = false;
            spinBtn.disabled = participants.length < 2;
            drawWheel(); 
        });

        loadVoiceParticipantsBtn.addEventListener('click', () => {
            if (voiceChannelMembers.length === 0) return;
            
            clearAllParticipants(); // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º
            
            const betAmount = parseInt(autoBetInput.value, 10) || 100;
            
            voiceChannelMembers.forEach((member, index) => {
                const name = member.nick || member.user.global_name || member.user.username;
                // [–§–ò–ö–° v6] –î–æ–±–∞–≤–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const id = member.user.id; 
                const avatarUrl = member.avatar 
                    ? `https://cdn.discordapp.com/avatars/${member.user.id}/${member.avatar}.png` 
                    : `https://cdn.discordapp.com/embed/avatars/${(BigInt(member.user.id) >> 22n) % 6n}.png`;
                const color = baseColors[index % baseColors.length];
                
                const participantData = { name, amount: betAmount, color, avatarUrl, id };

                if (offlineMode) {
                    participants.push(participantData);
                } else {
                    ws.send(JSON.stringify({ type: 'add_participant', data: participantData }));
                }
            });
            
            if (offlineMode) {
                updateParticipantsCardsList();
                drawWheel();
            }
        });

        // --- Initial Load ---
        
        window.addEventListener('resize', resizeCanvas);
        
        // –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
        resizeCanvas(); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        updateParticipantsCardsList();
        setupDiscordSdk();
        connectToBackend();

    </script>
</body>
</html>